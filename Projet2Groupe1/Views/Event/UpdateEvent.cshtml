@model Projet2Groupe1.ViewModels.EventViewModel
@{
    Layout = "_LayoutDashboard";
    ViewBag.Title = "Espace Personnel";

    ViewBag.Role = "ORGANIZER";
}

<head>
    <meta name="viewport" content="width=device-width" />
    <title>Vos évenements</title>
    <link href="~/css/UpdateEvent.css" rel="stylesheet" />
</head>
<h2>Vos évenements</h2>
<form id="eventForm" method="post" action="@Url.Action("UpdateEvents", "Event")">

    <input type="hidden" id="eventId" name="Event.Id" />
    <input type="hidden" id="eventName" name="Event.NameEvent" />
    <input type="hidden" id="typeEvent" name="Event.TypeEvent" />
    <input type="hidden" id="startEvent" name="Event.StartEvent" />
    <input type="hidden" id="endEvent" name="Event.EndEvent" />
    <input type="hidden" id="artistName" name="Event.Artist.NickNameArtist" />

<table id="eventTable">
    <thead>
        <tr>
            <th></th>
            <th>Nom de l'évenement</th>
            <th>Type Evenement</th>
            <th>Date de debut d'événement</th>
            <th>Date de fin d'événement</th>
            <th>Artiste</th>
            <th>Etat de la demande</th>


        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model.Events)
        {
            <tr data-id="@item.Id">
                     <td> 
                         @if(item.PhotoData!=null)
                         { 
                          String srcValue = "data:image.jpg;base64," + Convert.ToBase64String(@item.PhotoData) + ""; 


                         <img id="imgViewer" width="200" height="200" style="border:1px solid #000000" src=@srcValue /> 

                         }  
                         else{
                            <img class="event-card-image"
                                 src="@Url.Action("GetDefaultImage", "Event", new { type = item.TypeEvent })" />
                         }
                     </td> 
                <td>@item.NameEvent</td>
                <td>@item.TypeEvent</td>
                <td>@item.StartEvent.ToString("dd/MM/yyyy")</td>
                <td>@item.EndEvent.ToString("dd/MM/yyyy")</td>
                <td>@item.Artist.NickNameArtist</td>
                <td>@item.StatusRegistration</td>


            </tr>
        }
    </tbody>
</table>
    <div style="text-align: center; margin-top: 20px;">
        <button type="button" id="editButton">Editer Evenement</button>
        <button type="button" id="deleteButton">Supprimer Evenement</button>
    </div>
</form>


<script>
       let selectedRow = null;
  
    document.querySelectorAll('#eventTable tbody tr').forEach(row => {
        row.addEventListener('click', function () {
            if (selectedRow) {
                selectedRow.classList.remove('selected');
            }

            
            selectedRow = this;
            this.classList.add('selected');
            const eventId = selectedRow.getAttribute('data-id');
            document.getElementById('eventId').value = eventId;
        });
    });

    
    document.getElementById('editButton').addEventListener('click', function (event) {
        document.getElementById('deleteButton').disabled=true;
        console.log('Selected Row:'+ selectedRow);
        if (!selectedRow) {
            alert('Selectionner un évenement a modifier');
            return;
        }

        const cells = selectedRow.querySelectorAll('td');

        if (this.textContent === 'Editer Evenement') {
            cells.forEach((cell, index) => {
                const currentValue = cell.innerText;
                if(index === 0 ||index === 6) {

                }
                else if (index === 2) {
                    cell.innerHTML = `
                        <select>
                            <option value="CONCERT" ${currentValue === 'CONCERT' ? 'selected' : ''}>CONCERT</option>
                            <option value="FESTIVAL" ${currentValue === 'FESTIVAL' ? 'selected' : ''}>FESTIVAL</option>
                            <option value="SIGNINGSESSION" ${currentValue === 'SIGNINGSESSION' ? 'selected' : ''}>SIGNINGSESSION</option>
                        </select>
                    `;
                } 
                else {
                    cell.innerHTML = `<input type="text" value="${currentValue}" />`;
                }
            });
               this.textContent = 'Enregistrer';
              } else {
            
            function updateHiddenFields(cells) {
                document.getElementById('eventName').value = cells[1].querySelector('input').value;
                document.getElementById('typeEvent').value = cells[2].querySelector('select').value;
                document.getElementById('startEvent').value = cells[3].querySelector('input').value;
                document.getElementById('endEvent').value = cells[4].querySelector('input').value;
                document.getElementById('artistName').value = cells[5].querySelector('input').value;
            }

            updateHiddenFields(cells);

            cells.forEach((cell, index) => {
                if (index > 0 && index !==6) {
                    if (index === 2) {
                        const select = cell.querySelector('select');
                        cell.innerHTML = select.value;
                    } else {
                        const input = cell.querySelector('input');
                        cell.innerHTML = input.value;
                    }
                }
            });

            document.getElementById('eventForm').submit();
            this.textContent = 'Editer Evenement';
            selectedRow.classList.remove('selected');
            selectedRow = null;
        }
        event.preventDefault();
    });
    document.getElementById('deleteButton').addEventListener('click', function () {
        if (!selectedRow) {
            alert('Selectionner un évenement à supprimer');
            return;
        }

        if (confirm('Voulez-vous vraiment supprimer cet événement?')) {
            document.getElementById('eventForm').action = '@Url.Action("DeleteEvent", "Event")';
            document.getElementById('eventForm').submit();
        }
    });

</script>
